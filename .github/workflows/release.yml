# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Release

on:
  push:
    # Specifying branches is not really needed if the semantic-release configuration is correct.
    # It should still work to run on all branches.
    # feature branches shouldn't trigger a release
    # prerelease branches should trigger a prerelease
    # release branches should trigger a release
    # But this check requires the action to run which is redundant for feature branches.
    # Use this check so semantic-release doesn't need to run unnecessarily.
    # Gives a cleaner action history and saves on minutes :)
    branches:
      - "rc"
      - "main"
      - "master"
    
jobs:
  release:
    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v2
      with:
        # If we persist credentials at checkokut, the GITHUB_TOKEN later down don't take
        # see: https://github.com/semantic-release/git/issues/196
        persist-credentials: false  
    
    - uses: actions/setup-node@v2
      with:
        node-version: '16'
        cache: 'npm'
    
    - name: Setup dependencies
      run: npm ci
    
    - name: Build for release
      run: npm run build
      # Create prerelease, for configuratino see .releaserc file
    
    - name: Create release using semantic release
      env:
        GITHUB_TOKEN: ${{ secrets.PUBLIC_RELEASE_TOKEN }}
        GH_TOKEN: ${{ secrets.PUBLIC_RELEASE_TOKEN }}
        HUSKY: 0
      run: npx semantic-release       
